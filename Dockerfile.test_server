# Тестовый сервер на базе Ubuntu
FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive

# Ставим SSH-сервер и sudo (чтобы Ansible мог выполнять привилегированные задачи)
RUN apt-get update && apt-get install -y --no-install-recommends \
    openssh-server \
    sudo \
    python3 \
 && rm -rf /var/lib/apt/lists/*

# Создаём пользователя ansible
RUN useradd -m -d /home/ansible -s /bin/bash ansible && \
    mkdir -p /home/ansible/.ssh && \
    chown -R ansible:ansible /home/ansible/.ssh && \
    echo "ansible ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/ansible

# Готовим SSH-сервер
RUN mkdir -p /var/run/sshd

# Подключаем публичный ключ Ansible-агента
# (файл secrets/ansible_test_ssh_key.pub ты уже сгенерировал на прошлом шаге)
COPY secrets/ansible_test_ssh_key.pub /home/ansible/.ssh/authorized_keys

RUN chown ansible:ansible /home/ansible/.ssh/authorized_keys && \
    chmod 700 /home/ansible/.ssh && \
    chmod 600 /home/ansible/.ssh/authorized_keys

EXPOSE 22

CMD ["/usr/sbin/sshd", "-D", "-e"]
